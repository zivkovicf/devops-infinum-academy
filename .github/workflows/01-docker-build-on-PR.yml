name: 01-docker-build-on-PR

on:
  push:
    branches: [ "homework/*" ]
    paths:
      - "academy_project/app/src/**"
      - "academy_project/app/Dockerfile"
  pull_request:
    branches: [ "main" ]
    paths:
      - "academy_project/app/src/**"
      - "academy_project/app/Dockerfile"

jobs:

  build:
    runs-on: ubuntu-latest
    steps:
      -
        name: Checkout
        uses: actions/checkout@v3
      -
        name: Build Image
        run: docker build -t image ./academy_project/app
      -
        name: Save image
        run: docker save image > image.tar
      -
        name: Upload image artifact
        uses: actions/upload-artifact@v3
        with:
          name: image-artifact
          path: image.tar
  tag:
    needs: build
    runs-on: ubuntu-latest
    steps:
      -
        name: Dowload image artifact
        uses: actions/download-artifact@v3
        with:
          name: image-artifact
      -
        name: Load image
        run: docker load -i image.tar
      -
        name: Tag image
        run: docker tag image ${{ secrets.DOCKERHUB_USERNAME }}/devops-academy:03-pipelines
      -
        name: Save image
        run: docker save ${{ secrets.DOCKERHUB_USERNAME }}/devops-academy:03-pipelines > tagged-image.tar
      -
        name: Save image artifact
        uses: actions/upload-artifact@v3
        with:
          name: tagged-image-artifact
          path: tagged-image.tar
  push:
    needs: tag
    runs-on: ubuntu-latest
    steps:
      -
        name: Download image artifact
        uses: actions/download-artifact@v3
        with:
          name: tagged-image-artifact
      -
        name: Load image
        run: docker load -i tagged-image.tar
      -
        name: Login to dockerhub
        run: docker login --username ${{ secrets.DOCKERHUB_USERNAME }} --password ${{ secrets.DOCKERHUB_TOKEN }}
      -
        name: Push image
        run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/devops-academy:03-pipelines
